(self.webpackChunk_klaviyo_onsite_modules=self.webpackChunk_klaviyo_onsite_modules||[]).push([[7327],{73145:function(e,t,n){"use strict";var r=n(69899);n(7899);let o,a;const s=new WeakMap,i=new WeakMap,c=new WeakMap,l=new WeakMap,u=new WeakMap;let d={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return i.get(e);if("objectStoreNames"===t)return e.objectStoreNames||c.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return m(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function p(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(a||(a=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(y(this),t),m(s.get(this))}:function(...t){return m(e.apply(y(this),t))}:function(t,...n){const r=e.call(y(this),t,...n);return c.set(r,t.sort?t.sort():[t]),m(r)}}function f(e){return"function"==typeof e?p(e):(e instanceof IDBTransaction&&function(e){if(i.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{t(),r()},a=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)}));i.set(e,t)}(e),t=e,(o||(o=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,d):e);var t}function m(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{t(m(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",a)}));return t.then((t=>{t instanceof IDBCursor&&s.set(t,e)})).catch((()=>{})),u.set(t,e),t}(e);if(l.has(e))return l.get(e);const t=f(e);return t!==e&&(l.set(e,t),u.set(t,e)),t}const y=e=>u.get(e);function h(e,t,{blocked:n,upgrade:r,blocking:o,terminated:a}={}){const s=indexedDB.open(e,t),i=m(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(m(s.result),e.oldVersion,e.newVersion,m(s.transaction),e)})),n&&s.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),i.then((e=>{a&&e.addEventListener("close",(()=>a())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),i}const v=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],g=new Map;function w(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(g.get(t))return g.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=b.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!v.includes(n))return;const a=async function(e,...t){const a=this.transaction(e,o?"readwrite":"readonly");let s=a.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),o&&a.done]))[0]};return g.set(t,a),a}d=(e=>({...e,get:(t,n,r)=>w(t,n)||e.get(t,n,r),has:(t,n)=>!!w(t,n)||e.has(t,n)}))(d);const S="kl-post-identification-sync",k="kl-onsite-modules",I="kl-event-cache",D=JSON.stringify([]),B=()=>"indexedDB"in window,O={upgrade(e){e.objectStoreNames.contains(I)||e.createObjectStore(I,{autoIncrement:!0})}},j=(e,t)=>{B()?(async e=>{const t=(await h(k,1,O)).transaction(I,"readwrite"),n=t.objectStore(I);(async(e,t=1)=>{const n=await e.getAll(),r=n.length+t-1e4;if(r>0)for(let t=0;t<r;t+=1){const{id:t}=n[0];e.delete(t)}})(n);const{time:r,name:o}=e;return n.add({event:e,time:r,name:o}),t.done})(e).finally((()=>{t&&t()})):(async e=>{const t=localStorage.getItem(S),n=null===t?[]:JSON.parse(t);n.push(e),n.length>1e4&&n.shift(),localStorage.setItem(S,JSON.stringify(n))})(e).finally((()=>{t&&t()}))},E=async(e=1e3)=>B()?(async e=>{const t=await h(k,1,O),n=t.transaction(I,"readwrite").objectStore(I).openCursor(),r=[];let o,a=async()=>{};return await n.then((function n(s){if(s&&!(r.length>=e))return r.push(s.value.event),o=s.key,s.continue().then(n);o&&(a=()=>t.transaction(I,"readwrite").objectStore(I).delete(IDBKeyRange.upperBound(o)))})),{events:r||[],deleteCallback:a}})(e):(async e=>{const t=JSON.parse(localStorage.getItem(S)||D),n=t.slice(0,e),r=t.slice(e);return{events:n||[],deleteCallback:async()=>{localStorage.setItem(S,JSON.stringify(r))}}})(e),_=()=>B()?(async()=>(await h(k,1,O)).transaction(I,"readwrite").objectStore(I).clear())():(async()=>{localStorage.removeItem(S)})(),$=(e,t)=>{var n;const r=(new Date).toISOString(),o={name:e.event,time:(null==(n=e.properties)?void 0:n.time)||r,properties:e.properties||{}};j(o,t)};var x=n(53348),C=n.n(x),L=n(44050),N=n(28650),M=n(96497),A=n(113);n(35071),n(31217);const T=new Set(["$exchange_id","email","id","$email","$id","$anonymous","$phone_number"]),J=["name"],K=`${L.bl.url}${L.bl.eventBulkCreate}`;let P=!1;const V=(e,t,n)=>{const r=((e,t)=>({data:{type:"event-bulk-create",attributes:{profile:{data:{type:"profile",attributes:Object.assign({},t),meta:{identifiers:t}}},events:{data:e.map((e=>{const{name:t}=e,n=C()(e,J);return{type:"event",attributes:Object.assign({metric:{data:{type:"metric",attributes:{name:t}}}},n)}}))}}}}))(e,n);return(0,N.W)((()=>((e,t)=>fetch(`${K}/?company_id=${e}`,{method:"POST",headers:{"Access-Control-Allow-Headers":"*","Content-Type":"application/json","X-Klaviyo-Onsite":"1",revision:"2023-10-15"},body:JSON.stringify(t)}))(t,r)),5,1e3+1e3*Math.random(),[429])},W={$exchange_id:"_kx",email:"email",id:"id",$email:"email",$id:"id",$anonymous:"anonymous_id",$phone_number:"phone_number"},F=e=>{let t={};return Object.keys(W).forEach((n=>{if(r=n,Set.prototype.has.call(T,r)){const r=e[n];if(r){const e=("$email"===n||"email"===n)&&!(0,M.v)(r),o="$phone_number"===n&&!(0,A.y)(r);e||o||(t=Object.assign({},t,{[W[n]]:r}))}}var r})),t},R=(e,t,n)=>{if(0!==e.events.length)return V(e.events,t,n).then((async r=>{if(429===r.status)throw Error("Saving event cache due to rate limit.");return e.deleteCallback&&await e.deleteCallback(),E().then((e=>R(e,t,n)))}))},q=async(e,t,n)=>{const r=e||window.__klKey;if(!r||P)return;const o=F(t);o&&0!==Object.keys(o).length&&(P=!0,E().then((e=>R(e,r,o))).catch((e=>{throw console.error("Failed to send bulk events",e),e})).then((()=>{_(),n&&n()})).catch((e=>{console.error("Failed to clear storage",e)})).finally((()=>{P=!1})))};(()=>{(0,r.e)("cacheEvent",$),(0,r.e)("sendCachedEvents",q)})()},53348:function(e){e.exports=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o},e.exports.__esModule=!0,e.exports.default=e.exports}},function(e){e.O(0,[2462],(function(){return t=73145,e(e.s=t);var t}));e.O()}]);